<script type="text/javascript">
        var gk_isXlsx = false;
        var gk_xlsxFileLookup = {};
        var gk_fileData = {};
        function filledCell(cell) {
          return cell !== '' && cell != null;
        }
        function loadFileData(filename) {
        if (gk_isXlsx && gk_xlsxFileLookup[filename]) {
            try {
                var workbook = XLSX.read(gk_fileData[filename], { type: 'base64' });
                var firstSheetName = workbook.SheetNames[0];
                var worksheet = workbook.Sheets[firstSheetName];

                // Convert sheet to JSON to filter blank rows
                var jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, blankrows: false, defval: '' });
                // Filter out blank rows (rows where all cells are empty, null, or undefined)
                var filteredData = jsonData.filter(row => row.some(filledCell));

                // Heuristic to find the header row by ignoring rows with fewer filled cells than the next row
                var headerRowIndex = filteredData.findIndex((row, index) =>
                  row.filter(filledCell).length >= filteredData[index + 1]?.filter(filledCell).length
                );
                // Fallback
                if (headerRowIndex === -1 || headerRowIndex > 25) {
                  headerRowIndex = 0;
                }

                // Convert filtered JSON back to CSV
                var csv = XLSX.utils.aoa_to_sheet(filteredData.slice(headerRowIndex)); // Create a new sheet from filtered array of arrays
                csv = XLSX.utils.sheet_to_csv(csv, { header: 1 });
                return csv;
            } catch (e) {
                console.error(e);
                return "";
            }
        }
        return gk_fileData[filename] || "";
        }
        </script><!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FlashRead - RSVP Reader</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Roboto', sans-serif;
            display: flex;
            flex-direction: row;
            align-items: flex-start;
            justify-content: center;
            height: 100vh;
            margin: 0;
            background-color: #f0f0f0;
        }
        #reader {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-right: 20px;
        }
        #display {
            font-size: 48px;
            font-weight: 300;
            text-align: center;
            margin: 20px;
            height: 60px;
            min-width: 300px;
            border: 1px solid #cccccc;
            background-color: #ffffff;
            border-radius: 8px;
            line-height: 60px;
        }
        #controls {
            margin: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        button {
            padding: 10px 24px;
            margin: 5px;
            font-size: 16px;
            font-family: 'Roboto', sans-serif;
            font-weight: 500;
            cursor: pointer;
            border: none;
            background-color: #000000;
            color: #ffffff;
            border-radius: 12px;
            transition: background-color 0.2s;
        }
        button:hover {
            background-color: #333333;
        }
        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        #fileInput {
            display: none;
        }
        #speedControl, #fontSizeControl, #boldControl {
            margin: 10px;
            display: flex;
            align-items: center;
        }
        #speedControl label, #fontSizeControl label, #boldControl label {
            font-size: 16px;
            margin-right: 10px;
        }
        #speedSlider, #fontSizeSlider {
            -webkit-appearance: none;
            appearance: none;
            width: 150px;
            height: 4px;
            background: #cccccc;
            outline: none;
            border-radius: 2px;
        }
        #speedSlider::-webkit-slider-thumb, #fontSizeSlider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 12px;
            height: 12px;
            background: #000000;
            border-radius: 50%;
            cursor: pointer;
        }
        #speedSlider::-moz-range-thumb, #fontSizeSlider::-moz-range-thumb {
            width: 12px;
            height: 12px;
            background: #000000;
            border-radius: 50%;
            cursor: pointer;
        }
        #speedValue, #fontSizeValue {
            font-size: 16px;
            margin-left: 10px;
        }
        #boldFirstHalf {
            -webkit-appearance: none;
            appearance: none;
            width: 16px;
            height: 16px;
            background: #ffffff;
            border: 2px solid #cccccc;
            border-radius: 4px;
            cursor: pointer;
        }
        #boldFirstHalf:checked {
            background: #000000;
            border-color: #000000;
            position: relative;
        }
        #boldFirstHalf:checked::after {
            content: 'âœ”';
            color: #ffffff;
            position: absolute;
            top: -2px;
            left: 2px;
            font-size: 12px;
        }
        #pdfViewer {
            border: 1px solid #cccccc;
            max-height: 80vh;
            overflow-y: auto;
            background-color: #ffffff;
        }
        canvas {
            display: block;
            cursor: pointer;
        }
        #loading {
            font-size: 16px;
            margin: 10px;
            display: none;
        }
    </style>
</head>
<body>
    <div id="reader">
        <button id="fileButton">Choose File</button>
        <input type="file" id="fileInput" accept=".pdf">
        <div id="controls">
            <div id="speedControl">
                <label for="speedSlider">Reading Speed:</label>
                <input type="range" id="speedSlider" min="100" max="1400" value="700" step="10">
                <span id="speedValue">700 WPM</span>
            </div>
            <div id="fontSizeControl">
                <label for="fontSizeSlider">Font Size:</label>
                <input type="range" id="fontSizeSlider" min="24" max="72" value="48" step="1">
                <span id="fontSizeValue">48 px</span>
            </div>
            <div id="boldControl">
                <input type="checkbox" id="boldFirstHalf">
                <label for="boldFirstHalf">Half-Bold</label>
            </div>
            <div>
                <button onclick="startRSVP()">Start</button>
                <button id="pauseButton" onclick="togglePause()" disabled>Pause</button>
            </div>
        </div>
        <div id="loading">Loading PDF...</div>
        <div id="display">Upload a PDF to begin</div>
    </div>
    <div id="pdfViewer"></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.min.js"></script>
    <script>
        let words = [];
        let wordPositions = [];
        let currentWordIndex = 0;
        let intervalId = null;
        let isPaused = false;
        let WPM = 700;
        let delay = 60000 / WPM;
        let fontSize = 48;
        let boldFirstHalf = false;
        let pdfDoc = null;
        let canvases = [];
        let lastRenderedPage = null;

        // Update WPM when slider changes
        document.getElementById('speedSlider').addEventListener('input', (event) => {
            WPM = parseInt(event.target.value);
            document.getElementById('speedValue').textContent = `${WPM} WPM`;
            delay = 60000 / WPM;
            if (intervalId && !isPaused) {
                clearInterval(intervalId);
                startRSVP(false);
            }
        });

        // Update font size when slider changes
        document.getElementById('fontSizeSlider').addEventListener('input', (event) => {
            fontSize = parseInt(event.target.value);
            document.getElementById('fontSizeValue').textContent = `${fontSize} px`;
            document.getElementById('display').style.fontSize = `${fontSize}px`;
            updateDisplayText();
        });

        // Update bold first half setting
        document.getElementById('boldFirstHalf').addEventListener('change', (event) => {
            boldFirstHalf = event.target.checked;
            updateDisplayText();
        });

        // Update display text with bold first half if enabled
        function updateDisplayText() {
            if (currentWordIndex >= words.length) return;
            const word = words[currentWordIndex];
            if (boldFirstHalf && word.length > 1) {
                const midPoint = Math.ceil(word.length / 2);
                const firstHalf = word.slice(0, midPoint);
                const secondHalf = word.slice(midPoint);
                document.getElementById('display').innerHTML = `<b>${firstHalf}</b>${secondHalf}`;
            } else {
                document.getElementById('display').textContent = word;
            }
        }

        // Trigger file input click when custom button is clicked
        document.getElementById('fileButton').addEventListener('click', () => {
            document.getElementById('fileInput').click();
        });

        // Handle file upload
        document.getElementById('fileInput').addEventListener('change', async (event) => {
            const file = event.target.files[0];
            if (!file || file.type !== 'application/pdf') {
                alert('Please upload a PDF file.');
                return;
            }

            words = [];
            wordPositions = [];
            canvases = [];
            lastRenderedPage = null;
            document.getElementById('pdfViewer').innerHTML = '';
            document.getElementById('pauseButton').disabled = true;
            document.getElementById('loading').style.display = 'block';
            document.getElementById('display').textContent = 'Loading...';

            const arrayBuffer = await file.arrayBuffer();
            pdfDoc = await pdfjsLib.getDocument(arrayBuffer).promise;
            const totalPages = pdfDoc.numPages;
            console.log(`Loading PDF with ${totalPages} pages`);

            // Process all pages
            for (let i = 1; i <= totalPages; i++) {
                console.log(`Processing page ${i}`);
                const page = await pdfDoc.getPage(i);
                const content = await page.getTextContent();
                const viewport = page.getViewport({ scale: 1.0 });

                // Create canvas for each page
                const canvas = document.createElement('canvas');
                canvas.width = viewport.width;
                canvas.height = viewport.height;
                document.getElementById('pdfViewer').appendChild(canvas);
                const context = canvas.getContext('2d');
                canvases.push({ canvas, viewport, context, pageObj: page });

                // Render page
                await page.render({ canvasContext: context, viewport }).promise;
                console.log(`Page ${i} rendered`);

                // Add click handler for word selection
                canvas.addEventListener('click', (e) => handleCanvasClick(e, i));

                // Store word positions
                content.items.forEach(item => {
                    if (item.str.trim()) {
                        const transform = item.transform;
                        const x = transform[4];
                        const y = viewport.height - transform[5];
                        const width = item.width;
                        const height = item.height;
                        const pageWords = item.str.split(/\s+/).filter(word => word.length > 0);
                        const avgWordWidth = width / (pageWords.length || 1);
                        let currentX = x;
                        pageWords.forEach(word => {
                            words.push(word);
                            wordPositions.push({
                                page: i,
                                x: currentX,
                                y: y - height,
                                width: avgWordWidth + 2,
                                height: height + 2,
                                text: word
                            });
                            currentX += avgWordWidth;
                            console.log(`Word: ${word}, Page: ${i}, x: ${currentX}, y: ${y - height}, width: ${avgWordWidth + 2}, height: ${height + 2}`);
                        });
                    }
                });
                console.log(`Page ${i} processed, total words: ${words.length}`);
            }

            document.getElementById('loading').style.display = 'none';
            document.getElementById('display').textContent = 'Ready to start';
            document.getElementById('pauseButton').disabled = false;
            console.log(`PDF loaded, total pages: ${totalPages}, total words: ${words.length}`);
        });

        // Handle canvas click to select a word
        function handleCanvasClick(event, pageNum) {
            const canvas = canvases[pageNum - 1].canvas;
            const rect = canvas.getBoundingClientRect();
            const x = event.clientX - rect.left;
            const y = event.clientY - rect.top;

            let closestWordIndex = -1;
            let minDistance = Infinity;
            wordPositions.forEach((pos, index) => {
                if (pos.page === pageNum) {
                    const dx = x - (pos.x + pos.width / 2);
                    const dy = y - (pos.y + pos.height / 2);
                    const distance = Math.sqrt(dx * dx + dy * dy);
                    if (distance < minDistance) {
                        minDistance = distance;
                        closestWordIndex = index;
                    }
                }
            });

            if (closestWordIndex >= 0) {
                if (intervalId) {
                    clearInterval(intervalId);
                    intervalId = null;
                    isPaused = false;
                    document.getElementById('pauseButton').textContent = 'Pause';
                }
                currentWordIndex = closestWordIndex;
                updateDisplayText();
                lastRenderedPage = null;
                highlightWord();
                console.log(`Selected word: ${words[currentWordIndex]}, Index: ${currentWordIndex}, Page: ${wordPositions[currentWordIndex].page}`);
            }
        }

        // Highlight current word
        async function highlightWord() {
            if (currentWordIndex >= words.length) return;

            const pos = wordPositions[currentWordIndex];
            const pageIndex = pos.page - 1;
            const { canvas, context, viewport, pageObj } = canvases[pageIndex];

            if (lastRenderedPage !== pos.page) {
                await pageObj.render({ canvasContext: context, viewport }).promise;
                lastRenderedPage = pos.page;
                canvas.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }

            context.fillStyle = 'rgba(255, 255, 0, 0.3)';
            context.fillRect(pos.x, pos.y, pos.width, pos.height);
            console.log(`Highlighting: ${pos.text}, Page: ${pos.page}, x: ${pos.x}, y: ${pos.y}, width: ${pos.width}, height: ${pos.height}`);
        }

        // Start RSVP display
        function startRSVP(reset = true) {
            if (words.length === 0) {
                alert('Please upload a PDF file first.');
                return;
            }
            if (intervalId && !isPaused) return;
            if (reset) {
                currentWordIndex = 0;
                isPaused = false;
                lastRenderedPage = null;
                document.getElementById('pauseButton').textContent = 'Pause';
            }
            intervalId = setInterval(async () => {
                if (currentWordIndex < words.length) {
                    updateDisplayText();
                    await highlightWord();
                    currentWordIndex++;
                } else {
                    clearInterval(intervalId);
                    intervalId = null;
                    isPaused = false;
                    document.getElementById('pauseButton').textContent = 'Pause';
                    document.getElementById('pauseButton').disabled = true;
                    document.getElementById('display').textContent = 'Finished';
                }
            }, delay);
        }

        // Toggle pause/resume
        function togglePause() {
            if (!intervalId) {
                isPaused = false;
                document.getElementById('pauseButton').textContent = 'Pause';
                startRSVP(false);
            } else {
                clearInterval(intervalId);
                intervalId = null;
                isPaused = true;
                document.getElementById('pauseButton').textContent = 'Resume';
                document.getElementById('display').textContent = 'Paused';
            }
        }
    </script>
</body>
</html>